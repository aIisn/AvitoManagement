# AvitoManagement System

Система управления объявлениями Avito с автоматической обработкой изображений и интеграцией с Google Sheets.

## Описание

AvitoManagement - это веб-приложение для автоматизации создания уникальных объявлений с водяными знаками. Система включает:

- **Обработка изображений**: уникализация, добавление водяных знаков, изменение параметров
- **Управление менеджерами**: создание, переименование, удаление менеджеров
- **Загрузка фотографий**: структурированное хранение по категориям и позициям
- **Интеграция с Google Sheets**: автоматическая обработка задач из таблиц
- **Система авторизации**: регистрация, верификация email, управление сессиями

## Структура проекта

```
AvitoManagment/
├── server/                # Python backend
│   ├── main.py            # Основной Flask сервер
│   ├── modules/           # Модули приложения
│   │   ├── ad_processing.py      # Обработка объявлений
│   │   ├── auth_middleware.py    # Middleware авторизации
│   │   ├── google_sheets.py      # Интеграция с Google Sheets
│   │   ├── image_processing.py   # Обработка изображений
│   │   ├── user_management.py    # Управление пользователями
│   │   └── utils.py              # Утилиты
│   ├── config/            # Конфигурационные файлы
│   ├── data/              # Данные приложения
│   └── logs/              # Логи
├── client/                # Frontend (HTML/CSS/JS)
├── venv/                  # Виртуальное окружение Python
├── requirements.txt       # Все зависимости
├── requirements-minimal.txt # Минимальные зависимости
└── README.md             # Этот файл
```

## Установка

### 1. Клонирование репозитория

```bash
git clone <repository-url>
cd AvitoManagment
```

### 2. Создание виртуального окружения

```bash
python3 -m venv venv
source venv/bin/activate  # Linux/Mac
# или
venv\Scripts\activate     # Windows
```

### 3. Установка зависимостей

**Вариант 1: Все зависимости (рекомендуется для разработки)**
```bash
pip install -r requirements.txt
```

**Вариант 2: Минимальные зависимости (для продакшена)**
```bash
pip install -r requirements-minimal.txt
```

### 4. Настройка Redis (рекомендуется)

Redis используется для кэширования и хранения сессий. Установка Redis улучшит производительность:

```bash
# Ubuntu/Debian
sudo apt update
sudo apt install redis-server

# CentOS/RHEL
sudo yum install redis
# или
sudo dnf install redis

# macOS
brew install redis

# Запуск Redis
sudo systemctl start redis-server
sudo systemctl enable redis-server
```

**Примечание**: Если Redis недоступен, система автоматически переключится на файловое хранилище сессий.

### 5. Настройка конфигурации

Убедитесь, что файл `server/config/service_account.json` содержит корректные данные для Google Sheets API.

### 6. Запуск сервера

```bash
cd server
python main.py
```

Сервер будет доступен по адресу: `http://localhost:5000`

## Зависимости

### Основные модули

- **Flask 3.0.0** - веб-фреймворк
- **Pillow 10.2.0** - обработка изображений
- **numpy 2.2.6** - численные вычисления
- **pytz 2025.2** - работа с часовыми поясами

### Google API

- **gspread 6.2.1** - работа с Google Sheets
- **oauth2client 4.1.3** - OAuth аутентификация
- **google-auth 2.27.0** - Google API аутентификация

### Безопасность

- **bcrypt 4.1.2** - хеширование паролей
- **cryptography 46.0.2** - криптографические функции
- **PyJWT 2.10.1** - работа с JWT токенами

### Дополнительные

- **Flask-Cors 4.0.0** - CORS поддержка
- **redis 6.4.0** - кэширование и хранение сессий
- **requests 2.32.5** - HTTP запросы

## Использование

1. **Регистрация**: Создайте аккаунт через веб-интерфейс
2. **Верификация**: Подтвердите email адрес
3. **Авторизация**: Войдите в систему
4. **Создание менеджера**: Добавьте нового менеджера
5. **Загрузка логотипа**: Загрузите логотип для водяных знаков
6. **Структура папок**: Создайте структуру для фотографий
7. **Загрузка фото**: Загрузите исходные фотографии
8. **Обработка**: Запустите уникализацию изображений
9. **Получение ссылок**: Скопируйте ссылки на готовые объявления

## API Endpoints

### Авторизация
- `POST /api/auth/register` - регистрация
- `POST /api/auth/verify` - верификация email
- `POST /api/auth/login` - авторизация
- `POST /api/auth/logout` - выход
- `GET /api/auth/me` - данные текущего пользователя

### Управление менеджерами
- `GET /api/managers` - список менеджеров
- `POST /api/create-manager` - создание менеджера
- `POST /api/rename-manager` - переименование
- `POST /api/delete-manager` - удаление

### Файлы
- `GET /api/list` - список файлов
- `POST /api/upload` - загрузка файлов
- `POST /api/delete` - удаление файлов
- `POST /api/upload_logo` - загрузка логотипа

### Обработка
- `POST /api/uniquify` - уникализация изображений
- `GET /api/get_links` - получение ссылок
- `GET /api/count_ready` - подсчет готовых объявлений

### Redis управление
- `GET /api/redis/info` - информация о Redis
- `POST /api/redis/cache/clear` - очистка кэша
- `POST /api/redis/cache/set` - установка значения в кэш
- `GET /api/redis/cache/get` - получение значения из кэша
- `DELETE /api/redis/cache/delete` - удаление значения из кэша

## Логирование

Логи сохраняются в файл `server/logs/main.txt` и включают:
- Временные метки в московском часовом поясе
- Информацию о загрузках и обработке
- Ошибки и предупреждения
- Действия пользователей

## Безопасность

- Хеширование паролей с солью (bcrypt)
- JWT токены для сессий
- Redis для безопасного хранения сессий
- Валидация User-Agent
- Ограничение HTTP методов
- CORS настройки
- Защита от подозрительных запросов
- Автоматический fallback на файловое хранилище при недоступности Redis

## Разработка

### Добавление новых модулей

1. Создайте файл в `server/modules/`
2. Добавьте импорты в `main.py`
3. Обновите `requirements.txt` при необходимости

### Тестирование

```bash
cd server
python -c "from modules.utils import get_timestamp; print('OK')"
```

## Поддержка

При возникновении проблем проверьте:
1. Логи в `server/logs/main.txt`
2. Корректность конфигурации Google Sheets
3. Права доступа к файлам и папкам
4. Установленные зависимости

## Лицензия

[Укажите лицензию проекта]
